<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo Trade BTC by Ha Duy Du</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; min-height: 100vh; }
        .widget-container { border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); background: #1e293b; }
        .ai-gradient { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); }
        .ai-gradient.disabled { background: #475569; cursor: not-allowed; opacity: 0.7; }
        
        /* Custom Range Slider */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #ffffff; cursor: pointer; margin-top: -6px; box-shadow: 0 0 10px rgba(255,255,255,0.5); transition: transform 0.1s; }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.2); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #475569; border-radius: 2px; }
        
        /* Color specific sliders */
        .slider-margin::-webkit-slider-thumb { background: #facc15; }
        .slider-margin::-webkit-slider-runnable-track { background: #422006; }
        .slider-sl::-webkit-slider-thumb { background: #ef4444; }
        .slider-sl::-webkit-slider-runnable-track { background: #450a0a; }
        .slider-tp::-webkit-slider-thumb { background: #22c55e; }
        .slider-tp::-webkit-slider-runnable-track { background: #052e16; }

        /* Button Styles */
        .option-btn { background-color: #334155; color: #94a3b8; border: 1px solid transparent; transition: all 0.2s; font-size: 10px; }
        .option-btn:hover { background-color: #475569; color: white; }
        .option-btn.active { color: white; font-weight: bold; border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 0 10px rgba(0,0,0,0.2); }
        .interval-btn.active { background-color: #facc15; color: black; border-color: #facc15; }
        .leverage-btn.active { background-color: #f59e0b; color: black; }

        /* Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        
        /* Sync Status Indicator */
        .sync-status { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .sync-green { background-color: #22c55e; box-shadow: 0 0 5px #22c55e; }
        .sync-red { background-color: #ef4444; }
        .sync-yellow { background-color: #eab308; animation: pulse 1s infinite; }
        
        /* Modal */
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(4px); }
        .modal-content { background-color: #1e293b; margin: 10% auto; padding: 20px; border: 1px solid #475569; width: 90%; max-width: 400px; border-radius: 12px; position: relative; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* Loading Animation */
        @keyframes blink-dot { 0% { opacity: 0.2; transform: scale(1); } 50% { opacity: 1; transform: scale(1.3); } 100% { opacity: 0.2; transform: scale(1); } }
        .dot { display: inline-block; margin-left: 2px; font-size: 1.2em; }
        .dot:nth-child(1) { animation: blink-dot 1.2s infinite 0.0s; }
        .dot:nth-child(2) { animation: blink-dot 1.2s infinite 0.2s; }
        .dot:nth-child(3) { animation: blink-dot 1.2s infinite 0.4s; }
        .dot:nth-child(4) { animation: blink-dot 1.2s infinite 0.6s; }
        
        .edit-icon { cursor: pointer; opacity: 0.6; transition: all 0.2s; margin-left: 6px; font-size: 0.9rem; padding: 2px 6px; background: rgba(255,255,255,0.1); border-radius: 4px; }
        .edit-icon:hover { opacity: 1; color: #fff; background: rgba(255,255,255,0.2); }

        /* Toast Notification */
        .toast-notification {
            position: fixed; top: 24px; right: 24px;
            background-color: rgba(6, 78, 59, 0.95);
            color: #4ade80;
            padding: 16px 24px;
            border-radius: 8px; border: 1px solid #22c55e;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            z-index: 100;
            transform: translateX(150%);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-weight: bold; font-size: 0.95rem;
            display: flex; align-items: center; gap: 10px;
        }
        .toast-notification.active { transform: translateX(0); }
        .toast-error { background-color: rgba(127, 29, 29, 0.95); color: #f87171; border-color: #ef4444; }
    </style>
</head>
<body class="p-4 md:p-6 flex flex-col gap-4 text-sm">

    <!-- Header Section -->
    <header class="flex-none flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
            <h1 class="text-2xl font-bold text-white flex items-center gap-2">
                Demo Trade BTC 
                <span class="text-slate-500 text-xl font-light">|</span>
                by Ha Duy Du
            </h1>
            <p class="text-slate-400 text-xs flex items-center gap-2 mt-1">
                <span id="connection-status" class="sync-status sync-red"></span>
                <!-- Updated Loading Message -->
                <span id="user-id-display">ƒêang k·∫øt n·ªëi... (N·∫øu l√¢u, h√£y d√πng Live Server)</span>
            </p>
        </div>
        
        <!-- Auth Buttons -->
        <div id="auth-section" class="flex gap-2 items-center">
            <div id="auth-guest" class="flex gap-2">
                <button onclick="openModal('modal-login')" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white text-xs font-bold rounded-lg transition-colors">ƒêƒÉng Nh·∫≠p</button>
                <button onclick="openModal('modal-register')" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold rounded-lg transition-colors shadow-lg shadow-blue-500/20">ƒêƒÉng K√Ω</button>
            </div>
            <div id="auth-user" class="hidden flex items-center gap-3">
                <div class="text-right">
                    <div id="user-email" class="text-xs font-bold text-white">user@example.com</div>
                </div>
                <div class="flex flex-col gap-1">
                    <button onclick="logoutUser()" class="px-3 py-1 border border-red-500/50 text-red-400 hover:bg-red-500/10 text-[10px] rounded transition-colors w-full text-center">Tho√°t</button>
                    <button onclick="openModal('modal-change-pass')" class="px-3 py-1 border border-slate-500/50 text-slate-300 hover:bg-slate-700 text-[10px] rounded transition-colors w-full text-center">ƒê·ªïi MK</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Chart Section -->
    <div class="widget-container w-full h-[500px] flex-none relative z-0">
        <div id="tradingview_btc_chart" class="w-full h-full"></div>
        <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
        <script type="text/javascript">
            new TradingView.widget({
                "autosize": true, "symbol": "BINANCE:BTCUSDT", "interval": "30", "timezone": "Asia/Ho_Chi_Minh",
                "theme": "dark", "style": "1", "locale": "vi", "enable_publishing": false, "withdateranges": true,
                "hide_side_toolbar": false, "allow_symbol_change": true, "container_id": "tradingview_btc_chart"
            });
        </script>
    </div>

    <!-- Main Controls Area -->
    <div class="flex-1 grid grid-cols-1 lg:grid-cols-2 gap-4">
        
        <!-- LEFT: Control Panel -->
        <div class="widget-container p-5 border border-slate-700 bg-slate-900/90 h-full flex flex-col">
            <h3 class="text-sm font-bold text-white uppercase mb-4 flex items-center gap-2">üéõÔ∏è TH√îNG TIN L·ªÜNH</h3>

            <!-- Margin Input -->
            <div class="mb-5 bg-slate-800/30 p-3 rounded-lg border border-slate-700/50">
                <div class="flex justify-between items-end mb-2">
                    <label class="text-[10px] text-yellow-500 font-bold uppercase">K√Ω Qu·ªπ L·ªánh (Margin)</label>
                    <div class="flex items-center gap-1">
                        <span id="margin-val" class="text-lg font-mono font-bold text-white">$10,000</span>
                        <span onclick="editValue('margin')" class="edit-icon" title="Nh·∫≠p s·ªë ti·ªÅn th·ªß c√¥ng">‚úé</span>
                    </div>
                </div>
                <input type="range" min="0" max="500000" step="1000" value="10000" id="slider-margin" class="slider-margin" oninput="updateSliderVal(this.value, 'margin-val', '$')">
                <div class="relative w-full h-3 text-[9px] text-slate-500 mt-1 font-mono">
                    <span class="absolute left-0">$0</span>
                    <span class="absolute left-[50%] -translate-x-1/2">| $250k</span>
                    <span class="absolute right-0">$500k</span>
                </div>
            </div>

            <!-- Settings Grid -->
            <div class="grid grid-cols-2 gap-4 mb-5">
                <!-- Timeframe -->
                <div>
                    <p class="text-[10px] text-slate-400 uppercase font-bold mb-1">1. Khung Gi·ªù</p>
                    <div class="flex gap-1 flex-wrap">
                        <button onclick="setIntervalTime('15m')" class="option-btn interval-btn flex-1 py-1 rounded">15m</button>
                        <button onclick="setIntervalTime('30m')" class="option-btn interval-btn flex-1 py-1 rounded active">30m</button>
                        <button onclick="setIntervalTime('1h')" class="option-btn interval-btn flex-1 py-1 rounded">1h</button>
                        <button onclick="setIntervalTime('4h')" class="option-btn interval-btn flex-1 py-1 rounded">4h</button>
                        <button onclick="setIntervalTime('1D')" class="option-btn interval-btn flex-1 py-1 rounded">1D</button>
                        <button onclick="setIntervalTime('1W')" class="option-btn interval-btn flex-1 py-1 rounded">1W</button>
                    </div>
                </div>
                <!-- Leverage -->
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <p class="text-[10px] text-slate-400 uppercase font-bold">2. ƒê√≤n B·∫©y</p>
                        <div class="flex items-center">
                            <span id="leverage-val" class="text-xs font-bold text-orange-400">10x</span>
                            <span onclick="editValue('leverage')" class="edit-icon" title="Nh·∫≠p ƒë√≤n b·∫©y th·ªß c√¥ng">‚úé</span>
                        </div>
                    </div>
                    <div class="flex gap-1 flex-wrap">
                        <button onclick="setLeverage(10)" class="option-btn leverage-btn active flex-1 py-1 rounded">10x</button>
                        <button onclick="setLeverage(20)" class="option-btn leverage-btn flex-1 py-1 rounded">20x</button>
                        <button onclick="setLeverage(50)" class="option-btn leverage-btn flex-1 py-1 rounded">50x</button>
                        <button onclick="setLeverage(75)" class="option-btn leverage-btn flex-1 py-1 rounded">75x</button>
                        <button onclick="setLeverage(125)" class="option-btn leverage-btn flex-1 py-1 rounded text-red-400 font-bold">125x</button>
                    </div>
                </div>
            </div>

            <!-- SL / TP Sliders -->
            <div class="mb-5 p-3 bg-slate-800/50 rounded border border-slate-700/50 flex-1">
                <div class="mb-4">
                    <div class="flex justify-between items-end mb-1">
                        <label class="text-[10px] text-red-400 font-bold uppercase">D·ª´ng L·ªó (Stop Loss)</label>
                        <div class="flex items-center gap-1">
                            <span id="sl-val" class="text-sm font-mono font-bold text-red-400">20%</span>
                            <span onclick="editValue('sl')" class="edit-icon" title="S·ª≠a th·ªß c√¥ng">‚úé</span>
                        </div>
                    </div>
                    <input type="range" min="0" max="100" step="0.1" value="20" id="slider-sl" class="slider-sl" oninput="updateSliderVal(this.value, 'sl-val', '%')">
                </div>

                <div>
                    <div class="flex justify-between items-end mb-1">
                        <label class="text-[10px] text-green-400 font-bold uppercase">Ch·ªët L·ªùi (Take Profit)</label>
                        <div class="flex items-center gap-1">
                            <span id="tp-val" class="text-sm font-mono font-bold text-green-400">50%</span>
                            <span onclick="editValue('tp')" class="edit-icon" title="S·ª≠a th·ªß c√¥ng">‚úé</span>
                        </div>
                    </div>
                    <input type="range" min="0" max="100" step="0.1" value="50" id="slider-tp" class="slider-tp" oninput="updateSliderVal(this.value, 'tp-val', '%')">
                </div>
            </div>

            <!-- AI Button -->
            <button onclick="runPrediction()" id="predict-btn" class="mt-auto w-full py-3 ai-gradient hover:opacity-90 transition-all rounded-lg font-bold text-white shadow-lg shadow-purple-500/20 text-sm flex items-center justify-center gap-1 group">
                <span id="btn-text" class="group-hover:scale-105 transition-transform">Ph√¢n T√≠ch AI & V√†o L·ªánh</span>
            </button>
            <div id="ai-status" class="mt-2 text-[10px] text-slate-400 text-center italic h-4"></div>
        </div>

        <!-- RIGHT: Active & Journal -->
        <div class="widget-container flex flex-col min-h-[400px] bg-slate-800/50 h-full">
            <div class="flex border-b border-slate-700">
                <button onclick="switchTab('active')" id="tab-active" class="flex-1 py-3 text-xs font-bold text-white border-b-2 border-blue-500 bg-slate-800">ƒêang Ch·∫°y (<span id="active-count">0</span>)</button>
                <button onclick="switchTab('journal')" id="tab-journal" class="flex-1 py-3 text-xs font-bold text-slate-500 hover:text-slate-300">Nh·∫≠t K√Ω (<span id="journal-count">0</span>)</button>
            </div>

            <!-- Active List -->
            <div id="view-active" class="flex-1 overflow-y-auto custom-scroll p-0 relative">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-900 text-[9px] text-slate-400 sticky top-0 z-10 shadow-sm">
                        <tr>
                            <th class="p-2">V·ªã th·∫ø</th>
                            <th class="p-2 text-center text-blue-400">Khung</th>
                            <th class="p-2">Entry</th>
                            <th class="p-2 text-center">TP/SL</th>
                            <th class="p-2 text-right">PnL (ROE)</th>
                            <th class="p-2 text-right">PnL ($)</th>
                            <th class="p-2 text-center w-10">Act</th>
                        </tr>
                    </thead>
                    <tbody id="active-list" class="text-[11px] text-slate-300"></tbody>
                </table>
                <div id="empty-active" class="absolute inset-0 flex items-center justify-center text-[10px] text-slate-600 pointer-events-none">ƒêƒÉng nh·∫≠p ƒë·ªÉ xem l·ªánh...</div>
            </div>

            <!-- Journal List -->
            <div id="view-journal" class="hidden flex-1 flex flex-col min-h-0">
                <!-- Stats -->
                <div class="p-3 border-b border-slate-700 bg-slate-800/50">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] font-bold text-slate-400 uppercase">Hi·ªáu Su·∫•t</span>
                        <div class="flex bg-slate-700 rounded p-0.5">
                            <button onclick="updateStats('12h')" class="stat-filter-btn px-2 py-0.5 text-[9px] rounded text-slate-300 hover:bg-slate-600 active-stat" data-tf="12h">12H</button>
                            <button onclick="updateStats('24h')" class="stat-filter-btn px-2 py-0.5 text-[9px] rounded text-slate-300 hover:bg-slate-600" data-tf="24h">1D</button>
                            <button onclick="updateStats('7d')" class="stat-filter-btn px-2 py-0.5 text-[9px] rounded text-slate-300 hover:bg-slate-600" data-tf="7d">7D</button>
                            <button onclick="updateStats('30d')" class="stat-filter-btn px-2 py-0.5 text-[9px] rounded text-slate-300 hover:bg-slate-600" data-tf="30d">30D</button>
                            <button onclick="updateStats('1y')" class="stat-filter-btn px-2 py-0.5 text-[9px] rounded text-slate-300 hover:bg-slate-600" data-tf="1y">1Y</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <div class="bg-slate-900/50 p-2 rounded border border-slate-700 text-center"><div class="text-[9px] text-slate-500 uppercase">L√£i/L·ªó R√≤ng</div><div id="stat-pnl" class="text-sm font-bold font-mono text-slate-200">--</div></div>
                        <div class="bg-slate-900/50 p-2 rounded border border-slate-700 text-center"><div class="text-[9px] text-slate-500 uppercase">T·ªïng L·ªánh</div><div id="stat-count" class="text-sm font-bold font-mono text-slate-200">--</div></div>
                        <div class="bg-slate-900/50 p-2 rounded border border-slate-700 text-center"><div class="text-[9px] text-slate-500 uppercase">T·ªâ L·ªá Th·∫Øng</div><div id="stat-winrate" class="text-sm font-bold font-mono text-slate-200">--</div></div>
                    </div>
                </div>
                <!-- Table -->
                <div class="flex-1 overflow-y-auto custom-scroll relative">
                    <table class="w-full text-left border-collapse"><thead class="bg-slate-900 text-[9px] text-slate-400 sticky top-0 z-10"><tr><th class="p-2">Th·ªùi gian</th><th class="p-2 text-center">Khung</th><th class="p-2">L·ªánh</th><th class="p-2">L√Ω do</th><th class="p-2 text-right">K·∫øt qu·∫£</th><th class="p-2 text-center w-8"></th></tr></thead><tbody id="journal-list" class="text-[11px] text-slate-300"></tbody></table>
                    <div id="empty-journal" class="absolute inset-0 flex items-center justify-center text-[10px] text-slate-600 pointer-events-none">Ch∆∞a c√≥ l·ªãch s·ª≠</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="toast-success" class="toast-notification"><span class="text-xl">‚úì</span><span id="toast-message">Th√¥ng b√°o</span></div>
    <div id="modal-input" class="modal"><div class="modal-content w-[300px] border-blue-500/50 bg-slate-900 text-center"><h3 class="text-lg font-bold text-white mb-4" id="input-title">Nh·∫≠p Gi√° Tr·ªã</h3><input type="text" id="custom-input-field" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white text-center mb-4 font-mono text-lg" placeholder="0.0"><div id="input-error" class="text-red-400 text-xs mb-2 hidden font-bold">Gi√° tr·ªã kh√¥ng h·ª£p l·ªá</div><div class="flex gap-2"><button onclick="closeModal('modal-input')" class="flex-1 py-2 bg-slate-700 hover:bg-slate-600 rounded text-slate-300 text-xs font-bold">H·ªßy</button><button onclick="submitCustomInput()" class="flex-1 py-2 bg-blue-600 hover:bg-blue-500 rounded text-white text-xs font-bold">X√°c Nh·∫≠n</button></div></div></div>
    <div id="modal-change-pass" class="modal"><div class="modal-content w-[350px]"><span onclick="closeModal('modal-change-pass')" class="absolute top-2 right-4 text-slate-400 cursor-pointer text-xl font-bold">&times;</span><h2 class="text-lg font-bold text-white mb-4">ƒê·ªïi M·∫≠t Kh·∫©u</h2><div class="space-y-4"><input type="password" id="new-pass" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white text-sm" placeholder="M·∫≠t kh·∫©u m·ªõi"><input type="password" id="confirm-new-pass" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white text-sm" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u"><div id="change-pass-error" class="text-red-400 text-xs h-4"></div><button onclick="handleChangePassword()" class="w-full py-2 bg-purple-600 hover:bg-purple-500 rounded text-white font-bold text-sm">L∆∞u M·∫≠t Kh·∫©u M·ªõi</button></div></div></div>
    <div id="modal-menu" class="modal"><div class="modal-content w-[300px] border-slate-600 bg-slate-800"><h3 class="text-sm font-bold text-white mb-3 border-b border-slate-700 pb-2">T√πy Ch·ªçn L·ªánh <span id="menu-order-direction" class="ml-1">--</span></h3><div class="flex flex-col gap-2"><button onclick="viewOrderDetails()" class="flex items-center gap-3 p-3 bg-slate-700 hover:bg-slate-600 rounded text-left transition-colors"><span class="text-lg">üìÑ</span><div><div class="text-xs font-bold text-white">Chi Ti·∫øt L·ªánh</div><div class="text-[9px] text-slate-400">Xem Entry, TP, SL v√† PnL</div></div></button><button onclick="openDeleteConfirm()" class="flex items-center gap-3 p-3 bg-slate-700 hover:bg-red-900/40 text-left rounded transition-colors group"><span class="text-lg grayscale group-hover:grayscale-0">üóëÔ∏è</span><div><div class="text-xs font-bold text-red-400 group-hover:text-red-300">X√≥a L·ªánh</div><div class="text-[9px] text-slate-400 group-hover:text-red-300/70">X√≥a kh·ªèi l·ªãch s·ª≠ vƒ©nh vi·ªÖn</div></div></button></div><button onclick="closeModal('modal-menu')" class="mt-4 w-full py-2 text-xs text-slate-500 hover:text-white">ƒê√≥ng</button></div></div>
    <div id="modal-confirm-delete" class="modal"><div class="modal-content w-[300px] border-red-500/50 bg-slate-900 text-center"><div class="text-red-500 text-3xl mb-2">‚ö†Ô∏è</div><h3 class="text-lg font-bold text-white mb-2">X√°c Nh·∫≠n X√≥a</h3><p class="text-xs text-slate-400 mb-6">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a l·ªánh n√†y kh·ªèi l·ªãch s·ª≠? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</p><div class="flex gap-2"><button onclick="closeModal('modal-confirm-delete')" class="flex-1 py-2 bg-slate-700 hover:bg-slate-600 rounded text-slate-300 text-xs font-bold">H·ªßy</button><button onclick="executeDeleteOrder()" class="flex-1 py-2 bg-red-600 hover:bg-red-500 rounded text-white text-xs font-bold">X√≥a Vƒ©nh Vi·ªÖn</button></div></div></div>
    <div id="modal-details" class="modal"><div class="modal-content border-blue-900/50 bg-slate-900"><div class="flex justify-between items-start mb-4 border-b border-slate-800 pb-2"><div><h3 class="text-lg font-bold text-white">Chi Ti·∫øt L·ªánh</h3><p class="text-[10px] text-slate-500 font-mono" id="detail-id">--</p></div><button onclick="closeModal('modal-details')" class="text-slate-400 hover:text-white">‚úï</button></div><div class="space-y-3 font-mono text-sm"><div class="flex justify-between items-center p-2 bg-slate-800/50 rounded"><span class="text-slate-400 text-xs">ENTRY PRICE</span><span id="detail-entry" class="text-white font-bold">---</span></div><div class="flex justify-between items-center p-2 bg-slate-800/50 rounded"><span class="text-slate-400 text-xs">TARGET PROFIT (TP)</span><span id="detail-tp" class="text-green-400 font-bold">---</span></div><div class="flex justify-between items-center p-2 bg-slate-800/50 rounded"><span class="text-slate-400 text-xs">STOP LOSS (SL)</span><span id="detail-sl" class="text-red-400 font-bold">---</span></div><div class="mt-4 pt-3 border-t border-slate-800"><div class="flex justify-between items-center"><span class="text-slate-400 text-xs font-bold uppercase">K·∫æT QU·∫¢ (PnL)</span><span id="detail-pnl" class="text-xl font-black">---</span></div></div></div></div></div>
    <div id="modal-login" class="modal"><div class="modal-content w-[350px]"><span onclick="closeModal('modal-login')" class="absolute top-2 right-4 text-slate-400 cursor-pointer text-xl">&times;</span><h2 class="text-xl font-bold text-white mb-4">ƒêƒÉng Nh·∫≠p</h2><div class="space-y-4"><input type="email" id="login-email" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white text-sm" placeholder="Email"><input type="password" id="login-pass" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white text-sm" placeholder="M·∫≠t kh·∫©u"><div class="flex items-center gap-2"><input type="checkbox" id="login-remember" class="w-4 h-4 rounded bg-slate-800 border-slate-600 text-blue-600"><label for="login-remember" class="text-xs text-slate-400 cursor-pointer">Nh·ªõ m·∫≠t kh·∫©u (tr√™n thi·∫øt b·ªã n√†y)</label></div><div id="login-error" class="text-red-400 text-xs h-4"></div><button onclick="handleLogin()" class="w-full py-2 bg-slate-700 hover:bg-slate-600 rounded text-white font-bold text-sm">ƒêƒÉng Nh·∫≠p</button></div></div></div>
    <div id="modal-register" class="modal"><div class="modal-content w-[350px]"><span onclick="closeModal('modal-register')" class="absolute top-2 right-4 text-slate-400 cursor-pointer text-xl">&times;</span><h2 class="text-xl font-bold text-white mb-4">ƒêƒÉng K√Ω</h2><div class="space-y-4"><input type="email" id="reg-email" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white text-sm" placeholder="Email"><input type="password" id="reg-pass" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white text-sm" placeholder="M·∫≠t kh·∫©u"><input type="password" id="reg-pass-confirm" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white text-sm" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u"><div id="reg-error" class="text-red-400 text-xs h-4"></div><button onclick="handleRegister()" class="w-full py-2 bg-blue-600 hover:bg-blue-500 rounded text-white font-bold text-sm">ƒêƒÉng K√Ω Ngay</button></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updatePassword, setPersistence, browserLocalPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, setDoc, getDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ============================================================
        // ‚ñº‚ñº‚ñº C·∫§U H√åNH C·ª¶A B·∫†N ‚ñº‚ñº‚ñº
        const YOUR_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAw_rm5VlI8OzsG19Vf4siuAhrrDa9XIOQ",
            authDomain: "fir-trade-df3e0.firebaseapp.com",
            projectId: "fir-trade-df3e0",
            storageBucket: "fir-trade-df3e0.firebasestorage.app",
            messagingSenderId: "492373535078",
            appId: "1:492373535078:web:d869ac7df7b362614a80a7",
            measurementId: "G-J20JGR7GR7"
        };
        // ‚ö†Ô∏è ƒê√ÇY L√Ä CH·ªñ C·∫¶N THAY KEY M·ªöI C·ª¶A B·∫†N:
        const GEMINI_API_KEY = "AIzaSyAQ4SVA4DaiBNpYsIFHLTrVIOWB7qJhrZA"; 
        // ============================================================

        window.config = { interval: "30m", leverage: 10, margin: 10000, stopLoss: 20, takeProfit: 50 };
        window.activeOrders = [];
        window.journalEntries = [];
        window.currentStatFilter = '12h';
        window.selectedJournalEntry = null;
        window.currentEditType = null;
        
        let appId = 'default-btc-app';
        let userId = null;
        let db = null;
        let auth = null;
        let isRestoring = false; 
        
        // Prevent duplicate closing calls
        const closingOrderIds = new Set();

        const debounce = (func, delay) => {
            let timeoutId;
            return (...args) => { clearTimeout(timeoutId); timeoutId = setTimeout(() => func.apply(null, args), delay); };
        };

        window.formatMoney = (amount) => {
            return `$${Math.abs(amount).toLocaleString('vi-VN', { minimumFractionDigits: 1, maximumFractionDigits: 2 })}`;
        };

        // --- MATH HELPERS (TA) ---
        // Simple helper to calculate RSI/EMA for simulation
        const calculateSMA = (data, period) => {
            if (data.length < period) return 0;
            return data.slice(-period).reduce((a, b) => a + b, 0) / period;
        };
        const calculateEMA = (data, period) => {
             if (data.length === 0) return 0;
             const k = 2 / (period + 1);
             let ema = data[0];
             for (let i = 1; i < data.length; i++) {
                 ema = data[i] * k + ema * (1 - k);
             }
             return ema;
         };
        const calculateRSI = (closes, period = 14) => {
            if (closes.length < period + 1) return 50;
            let gains = 0, losses = 0;
             let avgGain = 0, avgLoss = 0;
            // First average
            for(let i = 1; i <= period; i++) {
                const diff = closes[i] - closes[i-1];
                if(diff >= 0) avgGain += diff; else avgLoss -= diff;
            }
            avgGain /= period;
            avgLoss /= period;
            // Smoothed
            for(let i = period + 1; i < closes.length; i++) {
                const diff = closes[i] - closes[i-1];
                 if(diff >= 0) {
                     avgGain = (avgGain * 13 + diff) / 14;
                     avgLoss = (avgLoss * 13) / 14;
                 } else {
                     avgGain = (avgGain * 13) / 14;
                     avgLoss = (avgLoss * 13 - diff) / 14;
                 }
            }
            if (avgLoss === 0) return 100;
            const rs = avgGain / avgLoss;
            return 100 - (100 / (1 + rs));
        };
        
        const calculateBollingerBands = (closes, period = 20, mult = 2) => {
             const sma = calculateSMA(closes, period);
             const slice = closes.slice(-period);
             const mean = slice.reduce((a,b)=>a+b,0)/period;
             const variance = slice.reduce((a,b)=>a+Math.pow(b-mean,2),0)/period;
             const stdDev = Math.sqrt(variance);
             return { upper: sma + mult*stdDev, lower: sma - mult*stdDev, middle: sma };
        };

        const calculateMACD = (closes) => {
            const getEMAArray = (data, period) => {
                const k = 2 / (period + 1);
                let ema = data[0];
                const emas = [ema];
                for (let i = 1; i < data.length; i++) {
                    ema = data[i] * k + ema * (1 - k);
                    emas.push(ema);
                }
                return emas;
            };
            const ema12 = getEMAArray(closes, 12);
            const ema26 = getEMAArray(closes, 26);
            const macdLine = ema12.map((v, i) => v - ema26[i]);
            const signalLine = getEMAArray(macdLine, 9);
            return { 
                macd: macdLine[macdLine.length-1], 
                signal: signalLine[signalLine.length-1], 
                hist: macdLine[macdLine.length-1] - signalLine[signalLine.length-1] 
            };
        };


        // --- GLOBAL UI ---
        window.switchTab = (tab) => {
            document.getElementById('view-active').classList.add('hidden');
            document.getElementById('view-journal').classList.add('hidden');
            document.getElementById('tab-active').className = "flex-1 py-3 text-xs font-bold text-slate-500 hover:text-slate-300";
            document.getElementById('tab-journal').className = "flex-1 py-3 text-xs font-bold text-slate-500 hover:text-slate-300";
            if(tab === 'active') {
                document.getElementById('view-active').classList.remove('hidden');
                document.getElementById('tab-active').className = "flex-1 py-3 text-xs font-bold text-white border-b-2 border-blue-500 bg-slate-800";
            } else {
                document.getElementById('view-journal').classList.remove('hidden');
                document.getElementById('tab-journal').className = "flex-1 py-3 text-xs font-bold text-white border-b-2 border-purple-500 bg-slate-800";
                window.updateStats(window.currentStatFilter);
            }
        };

        window.updateStats = (timeframe) => {
            window.currentStatFilter = timeframe;
            document.querySelectorAll('.stat-filter-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                if(btn.dataset.tf === timeframe) btn.classList.add('bg-blue-600', 'text-white');
            });
            const now = Date.now();
            let cutoff = 0;
            const hour = 3600 * 1000;
            if(timeframe === '12h') cutoff = now - (12 * hour);
            if(timeframe === '24h') cutoff = now - (24 * hour);
            if(timeframe === '7d') cutoff = now - (7 * 24 * hour);
            if(timeframe === '30d') cutoff = now - (30 * 24 * hour);
            if(timeframe === '1y') cutoff = now - (365 * 24 * hour);

            const filtered = window.journalEntries.filter(e => e.timestamp >= cutoff);
            const totalPnl = filtered.reduce((sum, e) => sum + (e.pnlValue || 0), 0);
            const winCount = filtered.filter(e => (e.pnlValue || 0) > 0).length;
            const totalCount = filtered.length;
            const winRate = filtered.length > 0 ? (winCount / filtered.length * 100) : 0;
            const pnlEl = document.getElementById('stat-pnl');
            pnlEl.innerText = window.formatMoney(totalPnl);
            pnlEl.className = `text-sm font-bold font-mono ${totalPnl >= 0 ? 'text-green-400' : 'text-red-400'}`;
            document.getElementById('stat-count').innerText = totalCount;
            const winEl = document.getElementById('stat-winrate');
            winEl.innerText = `${winRate.toFixed(1)}%`;
            winEl.className = `text-sm font-bold font-mono ${winRate >= 50 ? 'text-green-400' : 'text-orange-400'}`;
        };

        window.openMenu = (fid) => {
            window.selectedJournalEntry = window.journalEntries.find(e => e.firestoreId === fid);
            if(!window.selectedJournalEntry) return;
            const e = window.selectedJournalEntry;
            const color = e.direction === 'LONG' ? "text-green-500" : "text-red-500";
            document.getElementById('menu-order-direction').innerHTML = `<span class="${color}">${e.direction} x${e.leverage}</span>`;
            openModal('modal-menu');
        };

        window.viewOrderDetails = () => {
            const e = window.selectedJournalEntry;
            if(!e) return;
            closeModal('modal-menu');
            const lev = e.leverage || 10;
            const price = e.entryPrice || 0;
            let tpP = 0, slP = 0;
            if(price > 0) {
                const tpM = (e.tpPercent/lev)/100, slM = (e.slPercent/lev)/100;
                if(e.direction === 'LONG') { tpP = price * (1+tpM); slP = price * (1-slM); }
                else { tpP = price * (1-tpM); slP = price * (1+slM); }
            }
            const color = e.direction === 'LONG' ? "text-green-500" : "text-red-500";
            document.getElementById('detail-id').innerHTML = `<span class="${color} font-bold text-lg">${e.direction} x${lev}</span>`;
            document.getElementById('detail-entry').innerText = `$${price.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            document.getElementById('detail-tp').innerText = `$${tpP.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            document.getElementById('detail-sl').innerText = `$${slP.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            const pnlEl = document.getElementById('detail-pnl');
            pnlEl.innerText = window.formatMoney(e.pnlValue || 0);
            pnlEl.className = `text-xl font-black ${(e.pnlValue||0) >= 0 ? 'text-green-400' : 'text-red-400'}`;
            openModal('modal-details');
        };

        window.openDeleteConfirm = () => { closeModal('modal-menu'); openModal('modal-confirm-delete'); };
        
        window.executeDeleteOrder = async () => {
            const entry = window.selectedJournalEntry;
            if(!entry) return;
            closeModal('modal-confirm-delete');
            window.journalEntries = window.journalEntries.filter(x => x.firestoreId !== entry.firestoreId);
            renderJournal(); window.updateStats(window.currentStatFilter);
            try {
                // Query by ID to ensure correct deletion
                const q = query(collection(db, 'artifacts', appId, 'users', userId, 'journal_history'), where("id", "==", entry.id));
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach(async (d) => { await deleteDoc(d.ref); });
            } catch(e) { console.error("Delete Error:", e); window.showToast("L·ªói x√≥a l·ªánh!", true); }
        };

        window.editValue = (type) => {
            window.currentEditType = type;
            const inputField = document.getElementById('custom-input-field');
            document.getElementById('input-title').innerText = type === 'margin' ? "Nh·∫≠p Ti·ªÅn ($)" : (type === 'leverage' ? "Nh·∫≠p ƒê√≤n B·∫©y" : "Nh·∫≠p %");
            let val = type === 'margin' ? window.config.margin : (type === 'sl' ? window.config.stopLoss : (type === 'tp' ? window.config.takeProfit : window.config.leverage));
            inputField.value = val;
            openModal('modal-input');
            setTimeout(() => inputField.focus(), 100);
        };

        window.submitCustomInput = () => {
            let input = document.getElementById('custom-input-field').value.replace(',', '.');
            let num = parseFloat(input);
            if (isNaN(num) || num < 0) { document.getElementById('input-error').classList.remove('hidden'); return; }
            if (window.currentEditType === 'margin') {
                window.config.margin = num;
                document.getElementById('margin-val').innerText = window.formatMoney(num);
                const slider = document.getElementById('slider-margin'); if(num > 500000) slider.max = num; slider.value = num;
            } else if (window.currentEditType === 'leverage') {
                if (num < 1 || num > 125 || !Number.isInteger(num)) return;
                window.config.leverage = num; document.getElementById('leverage-val').innerText = num + 'x'; setLeverageUI(num);
            } else {
                num = parseFloat(num.toFixed(1));
                if (window.currentEditType === 'sl') { window.config.stopLoss = num; document.getElementById('slider-sl').value = num; document.getElementById('sl-val').innerText = num.toLocaleString('vi-VN') + '%'; }
                else { window.config.takeProfit = num; document.getElementById('slider-tp').value = num; document.getElementById('tp-val').innerText = num.toLocaleString('vi-VN') + '%'; }
            }
            saveSettings(); closeModal('modal-input');
        };

        window.updateSliderVal = (val, id, suffix = '') => {
            if(id === 'margin-val') { document.getElementById(id).innerText = window.formatMoney(parseInt(val)); window.config.margin = parseInt(val); }
            else { let num = parseFloat(val); document.getElementById(id).innerText = num.toLocaleString('vi-VN') + suffix; if(id === 'sl-val') window.config.stopLoss = num; if(id === 'tp-val') window.config.takeProfit = num; }
            saveSettings();
        };

        window.setIntervalTime = (label) => { window.config.interval = label; setIntervalTimeUI(label); saveSettings(); };
        window.setLeverage = (lev) => { window.config.leverage = lev; setLeverageUI(lev); document.getElementById('leverage-val').innerText = lev + 'x'; saveSettings(); };
        window.openModal = (id) => document.getElementById(id).style.display = 'block';
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';
        
        window.handleRegister = async () => {
            const email = document.getElementById('reg-email').value; const pass = document.getElementById('reg-pass').value; const confirm = document.getElementById('reg-pass-confirm').value;
            if(pass !== confirm) { document.getElementById('reg-error').innerText = "M·∫≠t kh·∫©u kh√¥ng kh·ªõp!"; return; }
            try { await createUserWithEmailAndPassword(auth, email, pass); closeModal('modal-register'); window.showToast("ƒêƒÉng k√Ω th√†nh c√¥ng!"); } catch (e) { document.getElementById('reg-error').innerText = "L·ªói: " + e.message; }
        };
        window.handleLogin = async () => {
            const email = document.getElementById('login-email').value; const pass = document.getElementById('login-pass').value; const remember = document.getElementById('login-remember').checked;
            try { await setPersistence(auth, remember ? browserLocalPersistence : browserSessionPersistence); await signInWithEmailAndPassword(auth, email, pass); closeModal('modal-login'); window.showToast("ƒêƒÉng nh·∫≠p th√†nh c√¥ng!"); } catch (e) { document.getElementById('login-error').innerText = "Sai email ho·∫∑c m·∫≠t kh·∫©u!"; }
        };
        window.handleChangePassword = async () => {
            const newPass = document.getElementById('new-pass').value; const confirmPass = document.getElementById('confirm-new-pass').value;
            if(newPass !== confirmPass) { document.getElementById('change-pass-error').innerText = "Kh√¥ng kh·ªõp!"; return; }
            try { if (auth.currentUser) { await updatePassword(auth.currentUser, newPass); window.showToast("ƒê√£ l∆∞u m·∫≠t kh·∫©u m·ªõi"); closeModal('modal-change-pass'); } } catch (e) { document.getElementById('change-pass-error').innerText = "L·ªói: " + e.message; }
        };
        window.showToast = (msg, isError = false) => {
            const toast = document.getElementById('toast-success'); document.getElementById('toast-message').innerText = msg;
            if (isError) { toast.classList.add('toast-error'); toast.querySelector('span:first-child').innerText = '‚úï'; } 
            else { toast.classList.remove('toast-error'); toast.querySelector('span:first-child').innerText = '‚úì'; }
            toast.classList.add('active'); setTimeout(() => toast.classList.remove('active'), 3000);
        }
        window.logoutUser = async () => await signOut(auth);

        // --- CORE FUNCTIONS ---
        const initFirebase = async () => {
            const statusDot = document.getElementById('connection-status');
            const userDisplay = document.getElementById('user-id-display');
            const authGuest = document.getElementById('auth-guest');
            const authUser = document.getElementById('auth-user');
            try {
                let firebaseConfig = YOUR_FIREBASE_CONFIG;
                appId = YOUR_FIREBASE_CONFIG.projectId || 'my-custom-app';
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid; statusDot.className = "sync-status sync-green";
                        if(user.isAnonymous) { userDisplay.innerText = "Guest Mode"; authGuest.classList.remove('hidden'); authUser.classList.add('hidden'); }
                        else { userDisplay.innerText = "Online"; document.getElementById('user-email').innerText = user.email; authGuest.classList.add('hidden'); authUser.classList.remove('hidden'); }
                        setupListeners(); loadSettings();
                    } else {
                        userId = null; statusDot.className = "sync-status sync-red"; userDisplay.innerText = "Disconnected"; authGuest.classList.remove('hidden'); authUser.classList.add('hidden'); window.activeOrders = []; window.journalEntries = []; renderActiveOrders(); renderJournal();
                    }
                });
            } catch (e) { console.error("Firebase Error:", e); }
        };

        const setupListeners = () => {
            if(!userId) return;
            onSnapshot(collection(db, 'artifacts', appId, 'users', userId, 'active_orders'), (snapshot) => {
                window.activeOrders = []; snapshot.forEach(doc => window.activeOrders.push({ firestoreId: doc.id, ...doc.data() })); window.activeOrders.sort((a, b) => a.id - b.id); renderActiveOrders();
            });
            onSnapshot(collection(db, 'artifacts', appId, 'users', userId, 'journal_history'), (snapshot) => {
                window.journalEntries = []; snapshot.forEach(doc => window.journalEntries.push({ firestoreId: doc.id, ...doc.data() })); window.journalEntries.sort((a, b) => b.timestamp - a.timestamp); renderJournal(); window.updateStats(window.currentStatFilter);
            });
        };

        const loadSettings = async () => {
            if(!userId) return; isRestoring = true;
            try { const docSnap = await getDoc(doc(db, 'artifacts', appId, 'users', userId, 'config', 'settings')); if (docSnap.exists()) { window.config = { ...window.config, ...docSnap.data() }; updateSliderUI(); setLeverageUI(window.config.leverage); setIntervalTimeUI(window.config.interval); } } catch (e) {}
            setTimeout(() => isRestoring = false, 500);
        };

        const saveSettings = debounce(async () => { if (!userId || isRestoring) return; await setDoc(doc(db, 'artifacts', appId, 'users', userId, 'config', 'settings'), window.config); }, 1000);

        window.runPrediction = async () => {
            if (!userId) return alert("Vui l√≤ng ƒëƒÉng nh·∫≠p!");
            const btn = document.getElementById('predict-btn');
            const btnText = document.getElementById('btn-text');
            const status = document.getElementById('ai-status');
            btn.disabled = true;
            btnText.innerHTML = `ƒêang ph√¢n t√≠ch<span class="dot">.</span><span class="dot">.</span><span class="dot">.</span><span class="dot">.</span>`;
            status.innerText = "ƒêang qu√©t 1000 n·∫øn & t√≠nh ch·ªâ b√°o...";

            try {
                // 1. Fetch REAL Candles (1000 candles)
                const intervalMap = { '15m':'15m', '30m':'30m', '1h':'1h', '4h':'4h', '1D':'1d', '1W':'1w' };
                const binanceInterval = intervalMap[window.config.interval] || '30m';
                
                let closes, currentPrice, klines;
                
                try {
                    const klinesRes = await fetch(`https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=${binanceInterval}&limit=1000`);
                    if(!klinesRes.ok) throw new Error("API Binance l·ªói/ch·∫∑n");
                    klines = await klinesRes.json();
                    
                    // Parse candles: [Time, Open, High, Low, Close, Vol]
                    closes = klines.map(k => parseFloat(k[4]));
                    currentPrice = closes[closes.length - 1];
                } catch(e) {
                     // Fallback: Generate realistic mock candle data
                     console.warn("Using Fallback Data Source");
                     closes = Array.from({length: 1000}, (_, i) => 96000 + Math.sin(i/10) * 500 + Math.random() * 200);
                     currentPrice = closes[closes.length - 1];
                     klines = closes.map((c, i) => [Date.now() - (1000-i)*60000, 0, 0, 0, c, Math.random() * 100]); // Mock klines
                }

                // 2. Compute Real Indicators (Simplistic Client-side)
                const rsi = Math.round(calculateRSI(closes, 14));
                const sma50 = calculateSMA(closes, 50);
                const sma200 = calculateSMA(closes, 200);
                const ema50 = calculateEMA(closes, 50);
                const bb = calculateBollingerBands(closes, 20);
                const macd = calculateMACD(closes);
                
                // Volume Extraction
                const volumes = klines.map(k => parseFloat(k[5]));
                const currentVol = volumes[volumes.length - 1];
                const avgVol = calculateSMA(volumes, 20);
                const volStatus = currentVol > avgVol ? "High" : "Low";
                
                const trend = currentPrice > sma50 ? "BULLISH" : "BEARISH";
                
                // 3. Send REAL DATA to AI
                const prompt = `
                Role: Quant Trader. 
                Data: BTC/USDT ${window.config.interval}. Price: ${currentPrice}.
                Volume Data: Current=${currentVol.toFixed(2)}, Avg20=${avgVol.toFixed(2)} (${volStatus}).
                Technical Indicators (Based on 1000 candles):
                - RSI (14): ${rsi}
                - MACD (12,26,9): Histogram=${macd.hist.toFixed(2)}
                - SMA50: ${sma50.toFixed(2)}
                - SMA200: ${sma200.toFixed(2)}
                - Bollinger Bands: Upper=${bb.upper.toFixed(2)}, Lower=${bb.lower.toFixed(2)}
                - Trend: ${trend}
                
                Task: Analyze volatility & momentum based on these indicators.
                Output JSON: {"up_prob": number, "down_prob": number, "reason": "Analyze RSI, MACD, and BB briefly"}
                `;
                
                let pred;
                // If API key is missing or invalid, generate "Simulated" analysis
                if (!GEMINI_API_KEY || GEMINI_API_KEY.includes("AIzaSyAQ")) {
                    await new Promise(r => setTimeout(r, 1500)); // Simulate delay
                    const isBull = trend === "BULLISH";
                    pred = {
                        up_prob: isBull ? 65 : 35,
                        down_prob: isBull ? 35 : 65,
                        reason: `M√¥ ph·ªèng: ${trend} trend, RSI ${rsi} (Mode Demo)`
                    };
                } else {
                     try {
                        const url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
                        const response = await fetch(`${url}?key=${GEMINI_API_KEY}`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });
                        
                        if(!response.ok) throw new Error("Gemini API Error");
                        const data = await response.json();
                        if (data.error) throw new Error(data.error.message);
                        
                        const textContent = data.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (!textContent) throw new Error("No text content");
                        
                        const jsonMatch = textContent.match(/\{.*\}/s);
                        if (!jsonMatch) throw new Error("Invalid JSON format");
                        
                        pred = JSON.parse(jsonMatch[0]);
                     } catch (aiErr) {
                        console.warn("AI call failed, using fallback:", aiErr);
                        // Fallback logic inside try block
                        const isBull = trend === "BULLISH";
                        pred = {
                            up_prob: isBull ? 60 + Math.random()*10 : 30 + Math.random()*10,
                            down_prob: isBull ? 40 - Math.random()*10 : 70 - Math.random()*10,
                            reason: `AI b·∫≠n, ph√¢n t√≠ch n·ªôi b·ªô: RSI=${rsi}, Xu h∆∞·ªõng=${trend}`
                        };
                     }
                }

                const dir = pred.up_prob >= pred.down_prob ? "LONG" : "SHORT";

                await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'active_orders'), {
                    id: Date.now().toString().slice(-6),
                    startTime: new Date().toLocaleTimeString(),
                    timestamp: Date.now(),
                    entryPrice: currentPrice,
                    direction: dir,
                    leverage: window.config.leverage,
                    margin: window.config.margin,
                    slPercent: window.config.stopLoss,
                    tpPercent: window.config.takeProfit,
                    reason: `${pred.reason} (RSI: ${rsi})`,
                    timeframe: window.config.interval // Added timeframe to order data
                });
                status.innerText = "";
                window.switchTab('active');

            } catch (e) { console.error(e); window.showToast("L·ªói k·∫øt n·ªëi", true); } 
            finally { btn.disabled = false; btnText.innerHTML = `Ph√¢n T√≠ch AI & V√†o L·ªánh`; }
        };

        window.manualCloseOrder = async (fid) => {
            const btn = document.getElementById(`btn-close-${fid}`);
            if(btn) { btn.disabled = true; btn.innerHTML = `<span class="loading-dots"></span>`; }
            try {
                let price = 96500;
                try {
                    const res = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT');
                    const ticker = await res.json();
                    price = parseFloat(ticker.price);
                } catch(e) { console.warn("Using mock price for close"); }

                const order = window.activeOrders.find(o => o.firestoreId === fid);
                if(!order) return;
                
                let raw = order.direction === "LONG" ? (price - order.entryPrice)/order.entryPrice : (order.entryPrice - price)/order.entryPrice;
                await performCloseOrder(order, "üîò ƒê√≥ng Tay", raw * 100 * order.leverage, order.margin * raw * order.leverage);
            } catch(e) { if(btn) { btn.disabled = false; btn.innerText = "‚úï"; } }
        };

        const performCloseOrder = async (order, reason, roe, pnl) => {
            if (closingOrderIds.has(order.firestoreId)) return; // Prevent double close
            closingOrderIds.add(order.firestoreId);

            try {
                await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'journal_history'), {
                    ...order, timestamp: Date.now(), reason, pnlValue: pnl, roe
                });
                await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'active_orders', order.firestoreId));
            } catch(e) {
                console.error("Close Error:", e);
                closingOrderIds.delete(order.firestoreId); // Retry possible if error
            }
        };

        setInterval(async () => {
            if (window.activeOrders.length === 0) return;
            try {
                let price = 96500;
                try {
                     const res = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT');
                     const ticker = await res.json();
                     price = parseFloat(ticker.price);
                } catch (e) { price = window.activeOrders[0].entryPrice; } // Fallback to entry if fetch fails
                
                window.activeOrders.forEach(o => {
                    let raw = o.direction === "LONG" ? (price - o.entryPrice)/o.entryPrice : (o.entryPrice - price)/o.entryPrice;
                    let roe = raw * 100 * o.leverage;
                    let pnl = o.margin * raw * o.leverage;

                    const row = document.getElementById(`row-${o.firestoreId}`);
                    if (row) {
                        const color = roe >= 0 ? "text-green-400" : "text-red-400";
                        row.querySelector('.pnl-roe').innerHTML = `<span class="${color}">${roe > 0 ? '+' : ''}${roe.toFixed(2)}%</span>`;
                        row.querySelector('.pnl-val').innerHTML = `<span class="${color}">${window.formatMoney(pnl)}</span>`;
                    }

                    if (!closingOrderIds.has(o.firestoreId) && (roe <= -o.slPercent || roe >= o.tpPercent)) {
                        performCloseOrder(o, roe <= -o.slPercent ? `‚õî SL` : `‚úÖ TP`, roe, pnl);
                    }
                });
            } catch(e) {}
        }, 3000);

        // --- UI Helpers Local ---
        const renderActiveOrders = () => {
            const list = document.getElementById('active-list');
            const count = document.getElementById('active-count');
            const empty = document.getElementById('empty-active');
            count.innerText = window.activeOrders.length;
            if (window.activeOrders.length === 0) { list.innerHTML = ""; empty.style.display = 'flex'; empty.innerText = userId ? "Ch∆∞a c√≥ l·ªánh n√†o ƒëang ch·∫°y" : "ƒêƒÉng nh·∫≠p ƒë·ªÉ b·∫Øt ƒë·∫ßu"; return; }
            empty.style.display = 'none';

            list.innerHTML = window.activeOrders.map(o => {
                const color = o.direction === 'LONG' ? "text-green-500" : "text-red-500";
                return `
                <tr id="row-${o.firestoreId}" class="border-b border-slate-800 hover:bg-slate-700/30 transition-colors">
                    <td class="p-2"><div class="font-bold text-[10px] ${color}">${o.direction} x${o.leverage}</div><div class="text-[9px] text-slate-500">${window.formatMoney(o.margin)}</div></td>
                    <td class="p-2 text-center font-mono text-xs text-blue-400">${o.timeframe || '30m'}</td>
                    <td class="p-2 font-mono text-slate-400">$${o.entryPrice.toLocaleString()}</td>
                    <td class="p-2 text-center text-[9px] font-mono"><span class="text-green-600 font-bold text-sm">${o.tpPercent}%</span> <span class="text-slate-600">/</span> <span class="text-red-600 font-bold text-sm">${o.slPercent}%</span></td>
                    <td class="p-2 text-right font-bold font-mono pnl-roe text-slate-500">...%</td>
                    <td class="p-2 text-right font-bold font-mono pnl-val text-slate-500">...$</td>
                    <td class="p-2 text-center"><button id="btn-close-${o.firestoreId}" onclick="manualCloseOrder('${o.firestoreId}')" class="bg-slate-700 hover:bg-red-500 text-slate-300 hover:text-white transition-colors text-[10px] w-6 h-6 rounded flex items-center justify-center font-bold">‚úï</button></td>
                </tr>`;
            }).join('');
        };

        const renderJournal = () => {
            const list = document.getElementById('journal-list');
            const count = document.getElementById('journal-count');
            const empty = document.getElementById('empty-journal');
            count.innerText = window.journalEntries.length;

            if (window.journalEntries.length === 0) { list.innerHTML = ""; empty.style.display = 'flex'; return; }
            empty.style.display = 'none';

            list.innerHTML = window.journalEntries.map(e => {
                const color = e.pnlValue >= 0 ? "text-green-400" : "text-red-400";
                const d = new Date(e.timestamp);
                const time = `${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')} | ${d.getDate()}/${d.getMonth()+1}/${String(d.getFullYear()).slice(-2)}`;
                return `
                <tr class="border-b border-slate-800 hover:bg-slate-800/50">
                    <td class="p-2 text-slate-400 font-mono text-[10px]">${time}</td>
                    <td class="p-2 text-center font-mono text-xs text-slate-400">${e.timeframe || '30m'}</td> <!-- Added Timeframe Column Data -->
                    <td class="p-2"><span class="font-bold ${e.direction === 'LONG' ? 'text-green-500' : 'text-red-500'}">${e.direction} x${e.leverage}</span></td>
                    <td class="p-2 text-slate-400 text-[10px]">${e.reason}</td>
                    <td class="p-2 text-right font-bold font-mono ${color}">${window.formatMoney(e.pnlValue)}</td>
                    <td class="p-2 text-center"><button onclick="openMenu('${e.firestoreId}')" class="text-slate-500 hover:text-white font-bold px-2 py-1 hover:bg-slate-700 rounded text-xs">...</button></td>
                </tr>`;
            }).join('');
        };

        const setIntervalTimeUI = (v) => { document.querySelectorAll('.interval-btn').forEach(b => { b.classList.remove('active'); if(b.innerText.toLowerCase()===v.toLowerCase()) b.classList.add('active'); }); };
        const setLeverageUI = (v) => { document.querySelectorAll('.leverage-btn').forEach(b => { b.classList.remove('active'); if(b.innerText === v+'x') b.classList.add('active'); }); };
        const updateSliderUI = () => {
            const m = document.getElementById('slider-margin'); m.value = window.config.margin; updateSliderVal(m.value, 'margin-val', '$');
            const sl = document.getElementById('slider-sl'); sl.value = window.config.stopLoss; updateSliderVal(sl.value, 'sl-val', '%');
            const tp = document.getElementById('slider-tp'); tp.value = window.config.takeProfit; updateSliderVal(tp.value, 'tp-val', '%');
            document.getElementById('leverage-val').innerText = window.config.leverage + 'x';
        };

        initFirebase();
    </script>
</body>
</html>
